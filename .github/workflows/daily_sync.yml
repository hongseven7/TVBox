name: Daily Upstream Sync & Script

on:
  # Runs at 00:00 UTC daily
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:
    inputs:
      logLevel:
        description: "Log level"
        required: true
        default: "warning"
        type: choice
        options:
          - info
          - warning
          - debug
      environment:
        description: "Environment to deploy to"
        required: true
        type: environment
      comment:
        description: "Manual dispatch"
        required: false
        type: string

jobs:
  sync-and-process:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Fork
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Configure Git Identity
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Add Upstream and Sync
        id: sync
        env:
          UPSTREAM_URL: https://github.com/yoursmile66/TVBox.git
          TARGET_BRANCH: main
        run: |
          BEFORE_SHA=$(git rev-parse HEAD)

          git remote add upstream $UPSTREAM_URL
          git fetch upstream
          git merge upstream/$TARGET_BRANCH --strategy-option=theirs --allow-unrelated-histories -m "Daily sync with upstream"
          git push origin $TARGET_BRANCH

          AFTER_SHA=$(git rev-parse HEAD)

          if [ "$BEFORE_SHA" != "$AFTER_SHA" ]; then
            echo "UPDATED=true" >> $GITHUB_ENV
          else
            echo "UPDATED=false" >> $GITHUB_ENV
          fi

      - name: Set up Python
        if: env.UPDATED == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install Dependencies
        if: env.UPDATED == 'true'
        env:
          SCRIPTS_DIR: ./.github/scripts
        run: |
          if [ -f $SCRIPTS_DIR\requirements.txt ]; then pip install -r $SCRIPTS_DIR\requirements.txt; fi
          echo "SCRIPTS_DIR=$SCRIPTS_DIR" >> $GITHUB_ENV

      - name: Run Custom Script
        if: env.UPDATED == 'true'
        run: |
          python $env.SCRIPTS_DIR/remove_proxy.py .

      - name: Commit and Push Script Changes
        if: env.UPDATED == 'true'
        run: |
          # Check if the script actually modified any files
          if [[ -n $(git status --porcelain) ]]; then
            echo "Script generated changes. Committing..."

            git add .
            git commit -m "Auto-update: Changes generated by daily script"
            git push origin HEAD
          else
            echo "Script ran successfully but modified no files. Nothing to push."
          fi
